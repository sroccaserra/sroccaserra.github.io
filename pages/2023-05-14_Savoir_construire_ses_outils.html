<!doctype html>
<html>
    <head>
        <link href="/style/main.css" rel="stylesheet">
        <title>Savoir construire ses outils</title>
        <meta charset="utf-8"/>
    </head>
    <body>
        <br/>
        <center>
            <a class="title" href="/index.html"><b>Journal d'Exploration Logicielle</b><br/></a>
        </center>
        <br/>
        2023-05-14
        <br/>
        <h1>Savoir construire ses outils</h1>
        <hr/>

        <p>
Parfois, face √† une situation nouvelle que je ne comprends pas, j‚Äôai besoin de voir le probl√®me sous un autre angle. Dans ces conditions, je suis content d‚Äôutiliser tous les outils que j‚Äôai d√©j√†. Et parfois, quand mes outils habituels ne sont pas adapt√©s, savoir fabriquer tr√®s vite un nouvel outil sp√©cifique √† la situation est tr√®s utile.
</p>
<p>
Voici le dernier exemple en date, o√π j‚Äôai eu besoin de visualiser des √©v√©nements sur un axe temporel pour les corr√©ler et chercher des patterns.
</p>
<p>
Dans ma mission actuelle, nous avons eu besoin d‚Äô√©tablir une connexion VPN entre un serveur applicatif et un serveur SMTP pour envoyer des emails. Et nous avons d√©tect√© que cette connexion √©tait d√©fectueuse r√©guli√®rement, car environ un email sur dix ne partait pas : le serveur applicatif n‚Äôarrivait pas √† joindre le serveur SMTP.
</p>
<p>
Autre point important : sur ce projet on n‚Äôa pas encore pris le temps ni le budget de s‚Äôoutiller sur l‚Äôanalyse de logs, avec des outils du march√© comme Datadog par exemple. Ces outils fonctionnent tr√®s bien et je les recommande, mais nous ne les avons pas encore sous la main, d‚Äôo√π cette d√©marche un peu plus rustique.
</p>
<p>
Voil√† la d√©marche que j‚Äôai suivie pour rendre visible les patterns de perte de connexion :
</p>
<ul>
    <li>activer les logs de ping VPN</li>
    <li>extraire des logs de ping les √©v√©nements qui m‚Äôint√©ressent</li>
    <li>dessiner un graph avec tous ces √©v√©nements</li>
</ul>

<h2>Exploration des logs</h2>

<p>
Une connexion VPN, pour se maintenir, envoie √† interval r√©gulier des pings entre client et serveur. J‚Äôai activ√© les logs de ces pings du point de vue de mon serveur applicatif. J‚Äôai donc dans mes logs des pings envoy√©s et des pings re√ßus.
</p>
<p>
Ces logs sont tr√®s verbeux, ils contiennent beaucoup d‚Äôinformation. En plissant les yeux, on peut voir dans ces lignes des lignes ‚ÄòRECEIVED PING PACKET‚Äô et ‚ÄòSENT PING‚Äô. On peut voire aussi des lignes ‚ÄòInactivity timeout‚Äô et ‚Äòping-restart‚Äô : ce sont les lignes qui montrent le probl√®me, le red√©marrage fr√©quent de la connexion VPN qui causait les pertes d‚Äôemails.
</p>

<pre>
2023-05-12 17:21:28.999239998 +0200 CEST [web-1] 2023-05-12 15:21:28 us=359574 UDP WRITE [41] to [AF_INET]12.34.56.789:1194: P_DATA_V2 kid=0 DATA len=40
2023-05-12 17:21:28.999245803 +0200 CEST [web-1] 2023-05-12 15:21:28 us=364929 UDP READ [41] from [AF_INET]12.34.56.789:1194: P_DATA_V2 kid=0 DATA len=40
2023-05-12 17:21:28.999246770 +0200 CEST [web-1] 2023-05-12 15:21:28 us=364965 TLS: tls_pre_decrypt, key_id=0, IP=[AF_INET]12.34.56.789:1194
2023-05-12 17:21:28.999247475 +0200 CEST [web-1] 2023-05-12 15:21:28 us=364984 PID_TEST [0] [SSL-0] [] 0:0 0:1 t=1683904888[0] r=[0,64,15,0,1] sl=[0,0,64,528]
2023-05-12 17:21:28.999248049 +0200 CEST [web-1] 2023-05-12 15:21:28 us=364993 RECEIVED PING PACKET
2023-05-12 17:21:39.000111417 +0200 CEST [web-1] 2023-05-12 15:21:38 us=479455 TLS: tls_pre_encrypt: key_id=0
2023-05-12 17:21:39.000143400 +0200 CEST [web-1] 2023-05-12 15:21:38 us=479527 SENT PING
2023-05-12 17:21:39.000152558 +0200 CEST [web-1] 2023-05-12 15:21:38 us=479567 UDP WRITE [41] to [AF_INET]12.34.56.789:1194: P_DATA_V2 kid=0 DATA len=40
2023-05-12 17:21:49.001203807 +0200 CEST [web-1] 2023-05-12 15:21:48 us=710285 TLS: tls_pre_encrypt: key_id=0
2023-05-12 17:21:49.001231283 +0200 CEST [web-1] 2023-05-12 15:21:48 us=710359 SENT PING
2023-05-12 17:21:49.001235143 +0200 CEST [web-1] 2023-05-12 15:21:48 us=710413 UDP WRITE [41] to [AF_INET]12.34.56.789:1194: P_DATA_V2 kid=0 DATA len=40
2023-05-12 17:21:59.002236188 +0200 CEST [web-1] 2023-05-12 15:21:58 us=745173 TLS: tls_pre_encrypt: key_id=0
2023-05-12 17:21:59.002246836 +0200 CEST [web-1] 2023-05-12 15:21:58 us=745261 SENT PING
2023-05-12 17:21:59.002287152 +0200 CEST [web-1] 2023-05-12 15:21:58 us=745302 UDP WRITE [41] to [AF_INET]12.34.56.789:1194: P_DATA_V2 kid=0 DATA len=40
2023-05-12 17:22:09.003668616 +0200 CEST [web-1] 2023-05-12 15:22:08 us=957512 TLS: tls_pre_encrypt: key_id=0
2023-05-12 17:22:09.003689111 +0200 CEST [web-1] 2023-05-12 15:22:08 us=957579 SENT PING
2023-05-12 17:22:09.003693708 +0200 CEST [web-1] 2023-05-12 15:22:08 us=957618 UDP WRITE [41] to [AF_INET]12.34.56.789:1194: P_DATA_V2 kid=0 DATA len=40
2023-05-12 17:22:20.004539495 +0200 CEST [web-1] 2023-05-12 15:22:19 us=79677 TLS: tls_pre_encrypt: key_id=0
2023-05-12 17:22:20.004544393 +0200 CEST [web-1] 2023-05-12 15:22:19 us=79749 SENT PING
2023-05-12 17:22:20.004545188 +0200 CEST [web-1] 2023-05-12 15:22:19 us=79805 UDP WRITE [41] to [AF_INET]12.34.56.789:1194: P_DATA_V2 kid=0 DATA len=40
2023-05-12 17:22:29.005460487 +0200 CEST [web-1] 2023-05-12 15:22:28 us=327448 [OpenVPN-Server-mon-serveur-vpn.com] Inactivity timeout (--ping-restart), restarting
2023-05-12 17:22:29.005472487 +0200 CEST [web-1] 2023-05-12 15:22:28 us=327506 PID packet_id_free
2023-05-12 17:22:29.005495216 +0200 CEST [web-1] 2023-05-12 15:22:28 us=327605 PID packet_id_free
2023-05-12 17:22:29.005500324 +0200 CEST [web-1] 2023-05-12 15:22:28 us=327617 PID packet_id_free
2023-05-12 17:22:29.005501491 +0200 CEST [web-1] 2023-05-12 15:22:28 us=327624 PID packet_id_free
2023-05-12 17:22:29.005552612 +0200 CEST [web-1] 2023-05-12 15:22:28 us=327640 PID packet_id_free
2023-05-12 17:22:29.005555228 +0200 CEST [web-1] 2023-05-12 15:22:28 us=327647 PID packet_id_free
2023-05-12 17:22:29.005555749 +0200 CEST [web-1] 2023-05-12 15:22:28 us=327654 PID packet_id_free
2023-05-12 17:22:29.005556455 +0200 CEST [web-1] 2023-05-12 15:22:28 us=327661 PID packet_id_free
2023-05-12 17:22:29.005568587 +0200 CEST [web-1] 2023-05-12 15:22:28 us=327672 TCP/UDP: Closing socket
2023-05-12 17:22:29.005569472 +0200 CEST [web-1] 2023-05-12 15:22:28 us=327690 PID packet_id_free
2023-05-12 17:22:29.005574817 +0200 CEST [web-1] 2023-05-12 15:22:28 us=327709 SIGUSR1[soft,ping-restart] received, process restarting
2023-05-12 17:22:29.005575207 +0200 CEST [web-1] 2023-05-12 15:22:28 us=327727 Restart pause, 5 second(s)
</pre>

<p>
On peut d√©j√† en tirer des informations mais ce n‚Äôest pas tr√®s pratique : dans l‚Äôexemple il y a une ou deux minutes de logs, et pour mon probl√®me j‚Äôai besoin d‚Äôanalyser un bon quart d‚Äôheure pour chercher des patterns.
</p>

<h2>Transformation des logs</h2>
<p>
J‚Äôai commenc√© par extraire les √©v√©nements qui m‚Äôint√©ressent avec rg` (un genre de `grep`) et √† les structurer pour isoler le timestamp.
</p>
<p>
Isoler les envois de pings :
</p>

<pre>
$ <b>rg</b> 'SENT PING' logs
99694:2023-05-12 17:20:53.995533501 +0200 CEST [web-1] 2023-05-12 15:20:53 us=775530 SENT PING
99697:2023-05-12 17:21:03.996518529 +0200 CEST [web-1] 2023-05-12 15:21:03 us=991544 SENT PING
99739:2023-05-12 17:21:18.998396048 +0200 CEST [web-1] 2023-05-12 15:21:18 us=82178 SENT PING
99833:2023-05-12 17:21:28.999163512 +0200 CEST [web-1] 2023-05-12 15:21:28 us=359535 SENT PING
99840:2023-05-12 17:21:39.000143400 +0200 CEST [web-1] 2023-05-12 15:21:38 us=479527 SENT PING
99843:2023-05-12 17:21:49.001231283 +0200 CEST [web-1] 2023-05-12 15:21:48 us=710359 SENT PING
99846:2023-05-12 17:21:59.002246836 +0200 CEST [web-1] 2023-05-12 15:21:58 us=745261 SENT PING
99849:2023-05-12 17:22:09.003689111 +0200 CEST [web-1] 2023-05-12 15:22:08 us=957579 SENT PING
99852:2023-05-12 17:22:20.004544393 +0200 CEST [web-1] 2023-05-12 15:22:19 us=79749 SENT PING
99894:2023-05-12 17:22:34.006820819 +0200 CEST [web-1] 2023-05-12 15:22:33 us=328337 SENT PING
99992:2023-05-12 17:22:44.007459739 +0200 CEST [web-1] 2023-05-12 15:22:43 us=490301 SENT PING
99995:2023-05-12 17:22:54.008443004 +0200 CEST [web-1] 2023-05-12 15:22:53 us=684270 SENT PING
</pre>

<p>
Extraire le timestamp avec `cut` (on d√©limite sur les espaces et on prend les deux premiers champs)  :
</p>

<pre>
$ <b>rg</b> 'SENT PING' logs | <b>cut</b> -d'  -f1-2
2023-05-12 17:20:53.995533501
2023-05-12 17:21:03.996518529
2023-05-12 17:21:18.998396048
2023-05-12 17:21:28.999163512
2023-05-12 17:21:39.000143400
2023-05-12 17:21:49.001231283
2023-05-12 17:21:59.002246836
2023-05-12 17:22:09.003689111
2023-05-12 17:22:20.004544393
2023-05-12 17:22:34.006820819
2023-05-12 17:22:44.007459739
2023-05-12 17:22:54.008443004
</pre>

<p>
Ajouter le marqueur ' &gt;' (pour signifier ‚Äúenvoy√©‚Äù) en fin de ligne, et envoyer le r√©sultat dans un fichier ‚Äúsent‚Äù (ici avec tee` pour visualiser le r√©sultat en m√™me temps) :
</p>

<pre>
$ <b>rg</b> 'SENT PING logs | <b>cut</b> -d' ' -f1-2 | <b>rg</b> '$' -r ' >' | <b>tee</b> sent
2023-05-12 17:20:53.995533501 >
2023-05-12 17:21:03.996518529 >
2023-05-12 17:21:18.998396048 >
2023-05-12 17:21:28.999163512 >
2023-05-12 17:21:39.000143400 >
2023-05-12 17:21:49.001231283 >
2023-05-12 17:21:59.002246836 >
2023-05-12 17:22:09.003689111 >
2023-05-12 17:22:20.004544393 >
2023-05-12 17:22:34.006820819 >
2023-05-12 17:22:44.007459739 >
2023-05-12 17:22:54.008443004 >
</pre>

<p>
Faire la m√™me chose avec les pings re√ßus :
</p>

<pre>
$ <b>rg</b> 'RECEIVED PING' logs | <b>cut</b> -d' ' -f1-2 | <b>rg</b> '$' -r ' < Received' | <b>tee</b> received
2023-05-12 17:20:12.991392556 < Received
2023-05-12 17:21:28.999248049 < Received
2023-05-12 17:22:44.007432531 < Received
2023-05-12 17:22:54.008453476 < Received
</pre>

<p>
Et les red√©marrages de session VPN :
</p>

<pre>
$ <b>rg</b> '12 17:.*Inactivity timeout' logs | <b>cut</b> -d' ' -f1-2 | <b>rg</b> '$' -r ' * Restart !!' | <b>tee</b> restart
2023-05-12 17:21:13.997629899 * Restart !!
2023-05-12 17:22:29.005460487 * Restart !!
</pre>

<p>
Ensuite on peut joindre les fichiers avec cat` et les trier (par date puisque c‚Äôest le d√©but de ligne) dans un fichier ‚Äúhistory‚Äù::
</p>

<pre>
$ <b>cat</b> received sent restarts | <b>sort</b> > history
$ <b>cat</b> history
2023-05-12 17:20:53.995533501 >
2023-05-12 17:21:03.996518529 >
2023-05-12 17:21:13.997629899 * Restart !!
2023-05-12 17:21:18.998396048 >
2023-05-12 17:21:28.999163512 >
2023-05-12 17:21:28.999248049 < Received
2023-05-12 17:21:39.000143400 >
2023-05-12 17:21:49.001231283 >
2023-05-12 17:21:59.002246836 >
2023-05-12 17:22:09.003689111 >
2023-05-12 17:22:20.004544393 >
2023-05-12 17:22:29.005460487 * Restart !!
2023-05-12 17:22:34.006820819 >
2023-05-12 17:22:44.007432531 < Received
2023-05-12 17:22:44.007459739 >
2023-05-12 17:22:54.008443004 >
2023-05-12 17:22:54.008453476 < Received
</pre>

<p>
C‚Äôest d√©j√† plus lisible, on peut maintenant commencer √† corr√©ler et voir des patterns. En plissant les yeux, on peut voir que les pings envoy√©s sont beaucoup plus fr√©quents que les pings re√ßus.
</p>
<p>
On peut voir aussi que le red√©marrage de 17h22 survient une minute et une seconde apr√®s le dernier ping re√ßu : √ßa correspond √† notre configuration VPN : envoyez-vous des pings toutes les 10 secondes, et red√©marrez si vous n‚Äôavez pas de nouvelles apr√®s 1 mn. Mais j‚Äôavais envie de voir ces infos sur un graph pendant une longue p√©riode pour mieux confirmer mes intuitions.
</p>

<h2>Affichage dans un graph</h2>

<p>
√áa tombe bien, √ßa fait longtemps que j‚Äôavais envie d‚Äôexplorer l‚Äôaspect visuel de Smalltalk, un petit langage qui contient tout ce qu‚Äôil faut pour g√©n√©rer des images et les afficher out of the box (petit, en effet : 30 Mo le zip avec la VM, la lib standard, toutes les sources, et un IDE puissant int√©gr√© !).
</p>
<p>
J‚Äôai donc explor√© un peu et j‚Äôai trouv√© une classe `RSChart` qui pouvait afficher des `RSLinePlot` et des `RSScatterPlot`. Dans les commentaires de la classe il y a m√™me tout ce qu‚Äôil faut pour d√©marrer (voir exemple ci-dessous).
</p>
<p>
En explorant quelques minutes de plus, j‚Äôai trouv√© comment ajouter des marqueurs, et en peu de temps j‚Äôavais ce r√©sultat √† partir de mes logs, exactement ce dont j‚Äôavais besoin :
</p>

<img class="center" src="/images/2023-05-14_graph.png" width="800" height="486" />

<p>
On peut voir qu‚Äôil y a effectivement un pattern super r√©gulier : mon client VPN re√ßoit des pings du serveur pendant quelques dizaines de secondes, ne re√ßoit pas les pings du serveur pendant une minute et red√©marre. Et ainsi de suite.
</p>
<p>
En r√©fl√©chissant un peu, j‚Äôai pu faire l‚Äôhypoth√®se qu‚Äôil y avait une autre machine qui utilisait la m√™me configuration. Quand le serveur voyait cette autre machine arriver, il lui se mettait √† lui envoyer les pings et mon serveur ne les recevait plus. Ma connexion red√©marre, le serveur m‚Äôenvoie les pings, (donc l‚Äôautre machine ne les re√ßoit plus et red√©marre), et ainsi de suite, √† toi, √† moi, etc.
</p>
<p>
Et bingo, j‚Äôavais bien utilis√© la m√™me conf VPN sur deux de mes serveurs qui se volaient la vedette √† chacun leur tour ü§¶. Probl√®me enfin r√©solu ! üéâ
</p>

<h2>Conclusion</h2>

<p>
Pour r√©sumer, bien conna√Ætre GNU core-utils et un langage de programmation un peu visuel permet de se fabriquer ses propres outils sp√©cifiques rapidement et √† peu de frais, √† tel point que je ne ‚Äúcapitalise‚Äù pas sur ces outils, je n‚Äôen fait surtout pas une librairie. Je conserve quelques snippets pour me rappeler rapidement les d√©tails, et je me reconstruis un outil vite fait √† chaque fois, en jetant parfois un ≈ìil √† un de mes vieux snippets.
</p>

<h2>Annexe</h2>

<h3>Version awk</h3>

<p>
On peut faire toute la phase d‚Äôexploration de logs en une seule ligne de awk :
</p>

<pre>
$ <b>awk</b> &lt;logs '/SENT PING/ { print $1 $2 " >" } ; /RECEIVED PING/ { print $1 $2 " < Received"} ; /Inactivity/ { print $1 $2 " * Restart !!" }'
2023-05-1217:20:43.994461854 >
2023-05-1217:20:53.995533501 >
2023-05-1217:21:03.996518529 >
2023-05-1217:21:13.997629899 * Restart !!
2023-05-1217:21:18.998396048 >
2023-05-1217:21:28.999163512 >
2023-05-1217:21:28.999248049 < Received
2023-05-1217:21:39.000143400 >
2023-05-1217:21:49.001231283 >
2023-05-1217:21:59.002246836 >
2023-05-1217:22:09.003689111 >
2023-05-1217:22:20.004544393 >
2023-05-1217:22:29.005460487 * Restart !!
2023-05-1217:22:34.006820819 >
2023-05-1217:22:44.007432531 < Received
2023-05-1217:22:44.007459739 >
2023-05-1217:22:54.008443004 >
2023-05-1217:22:54.008453476 < Received
</pre>

<h3>Code du graph en Pharo Smalltalk</h3>

<p>
Si vous connaissez Ruby, une bonne partie de Smalltalk va vous para√Ætre famili√®re : les collections, les blocks de code, et le paradigme "tout est message".
</p>
<p>
Exemple simple pour afficher une sinuso√Øde :
</p>

<pre>
x := -3.14 to: 3.14 by: 0.1.
y := x sin.

c := RSChart new.
c addPlot: (RSLinePlot new x: x y: y).
c addDecoration: (RSChartTitleDecoration new title: 'hello'; fontSize: 20).
c addDecoration: (RSXLabelDecoration new title: 'My X Axis'; fontSize: 12).
c addDecoration: (RSYLabelDecoration new title: 'My Y Axis; fontSize: 15).
c show
</pre>

<img class="center" src="/images/2023-05-14_sinus.png" width="613" height="592" />

<p>
Voil√† tout le code √©crit rapidement pour le graph des red√©marrages. √áa tient en une vingtaine de lignes :
</p>

<pre>
file := FileSystem disk workingDirectory
    	/ 'Developer/OCTO/DITP/pilote-2/history'.
lines := file contents lines allButFirst: 8.

c := RSChart new.

y := 1.
xS := (lines select: [ :each | each endsWith: ' >' ]) collect: [ :line |
      	(DateAndTime fromString: (line first: 23)) asUnixTime ].
c addPlot:
    (RSScatterPlot new x: xS y: (OrderedCollection new: xS size withAll: y)).

y := 1.5.
xRc := (lines select: [ :each | each endsWith: 'Received' ]) collect: [ :line |
       	(DateAndTime fromString: (line first: 23)) asUnixTime ].
c addPlot:
    (RSScatterPlot new x: xRc y: (OrderedCollection new: xRc size withAll: y)).

((lines select: [ :each | each endsWith: 'Restart !!' ]) collect: [ :line |
     (DateAndTime fromString: (line first: 23)) asUnixTime ]) do: [ :value |
    c addDecoration: (RSXMarkerDecoration new value: value) ].

c addDecoration: (RSHorizontalTick new labelConversion: [ :value |
   	  (DateAndTime fromUnixTime: value) asTime ]).
c addDecoration: (RSXLabelDecoration new
   	  title: 'Heure';
   	  fontSize: 12).

c padding: 0 @ 80.
c show
</pre>

<p>
Le site de Pharo Smalltalk, qui permet de faire tourner ce code out of the box : <a href="https://pharo.org/">https://pharo.org/</a>
</p>


    </body>
</html>
